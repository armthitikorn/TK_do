<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>แบบทดสอบปรนัย</title>
</head>
<body>
  <h2>แบบทดสอบปรนัย: การขายประกันชีวิตและสุขภาพผ่านทางโทรศัพท์ (50 ข้อ)</h2>
  <div id="loading">กำลังโหลดแบบทดสอบ...</div>
  <form id="quizForm" class="hidden"></form>
  <button id="submitBtn" class="hidden">ส่งคำตอบ</button>
  <div id="result"></div>
  <a href="index3.html"><button style="margin-top: 20px;">ไปหน้าถัดไป</button></a>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

    const supabaseUrl = 'https://wzwyotzzxycqfwercakh.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind6d3lvdHp6eHljcWZ3ZXJjYWtoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcwNTg3MTMsImV4cCI6MjA3MjYzNDcxM30.lgiAf9oBUqsaWGb3u_80wuoKAODQHE_lIBxpGumhrno';
    const supabase = createClient(supabaseUrl, supabaseKey);

    let currentUser = null;
    const { data: { user }, error } = await supabase.auth.getUser();
    if (user) {
      currentUser = user;
    }

    const questions = [
      { q: "1. ข้อใดคือเป้าหมายหลักของการขายประกันผ่านโทรศัพท์", a: "B", choices: ["สร้างความสัมพันธ์", "ปิดการขาย", "ให้ข้อมูลเท่านั้น", "สอบถามความสนใจ"] },
      { q: "2. สิ่งที่ควรทำเมื่อเริ่มโทรหาลูกค้า", a: "A", choices: ["แนะนำตัวและชื่อบริษัท", "ถามคำถามทันที", "อธิบายผลิตภัณฑ์เลย", "ถามถึงรายได้ลูกค้า"] }
    ];

    const quizForm = document.getElementById('quizForm');
    const submitBtn = document.getElementById('submitBtn');
    const loading = document.getElementById('loading');
    const resultDiv = document.getElementById('result');

    function renderQuiz() {
      loading.classList.add('hidden');
      quizForm.classList.remove('hidden');
      submitBtn.classList.remove('hidden');

      questions.forEach((q, index) => {
        const container = document.createElement('div');
        const questionTitle = document.createElement('h3');
        questionTitle.textContent = q.q;
        container.appendChild(questionTitle);

        q.choices.forEach((choice, i) => {
          const label = document.createElement('label');
          const input = document.createElement('input');
          input.type = 'radio';
          input.name = `question-${index}`;
          input.value = String.fromCharCode(65 + i);
          label.appendChild(input);
          label.appendChild(document.createTextNode(`${input.value}. ${choice}`));
          container.appendChild(label);
        });

        quizForm.appendChild(container);
      });
    }

    renderQuiz();

    submitBtn.addEventListener('click', async () => {
      let score = 0;
      const answers = [];

      questions.forEach((q, index) => {
        const selected = document.querySelector(`input[name="question-${index}"]:checked`);
        const answer = selected ? selected.value : null;
        answers.push(answer);
        if (answer === q.a) score++;
      });

      const totalQuestions = questions.length;
      const userId = currentUser?.id || "anonymous";
      const userEmail = currentUser?.email || "anonymous@example.com";

      const response = await fetch(`${supabaseUrl}/rest/v1/quiz_results`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "apikey": supabaseKey,
          "Authorization": `Bearer ${supabaseKey}`,
          "Prefer": "return=representation"
        },
        body: JSON.stringify({
          user_id: userId,
          user_email: userEmail,
          score: score,
          total_questions: totalQuestions,
          answers: answers
        })
      });

      if (!response.ok) {
        const errorText = await response.text();
        console.error("Error saving quiz result:", errorText);
        resultDiv.textContent = "เกิดข้อผิดพลาดในการบันทึกผล กรุณาลองใหม่";
        resultDiv.style.backgroundColor = "#ffd1d1";
        resultDiv.style.color = "#900";
      } else {
        const data = await response.json();
        console.log("Saved:", data);
        resultDiv.textContent = `คุณได้คะแนน ${score} จาก ${totalQuestions} ข้อ`;
        resultDiv.style.backgroundColor = "#d1ffd1";
        resultDiv.style.color = "#005900";
      }

      resultDiv.style.display = "block";
      submitBtn.disabled = true;
    });
  </script>
</body>
</html>
