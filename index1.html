<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>แบบทดสอบปรนัย</title>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* โค้ด CSS สไตล์เดิม */
        body {
            font-family: 'Sarabun', sans-serif;
            max-width: 900px;
            margin: 30px auto;
            background-color: #f9faff;
            color: #333;
            padding: 20px;
        }
        h2 {
            color: #004080;
            text-align: center;
            margin-bottom: 30px;
        }
        .question-container {
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            padding: 25px;
            margin-bottom: 25px;
        }
        .question h3 {
            color: #0059b3;
            margin-bottom: 10px;
            font-size: 1.1rem;
        }
        .choices {
            list-style: none;
            padding: 0;
        }
        .choices li {
            margin-bottom: 8px;
        }
        .choices label {
            display: block;
            background: #e6f2ff;
            padding: 12px;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        .choices label:hover {
            background-color: #cce6ff;
        }
        input[type="radio"] {
            margin-right: 10px;
        }
        button {
            display: block;
            width: 100%;
            max-width: 300px;
            padding: 15px;
            font-size: 1.1rem;
            background-color: #007acc;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            margin: 20px auto 0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.15);
        }
        button:hover {
            background-color: #005fa3;
        }
        #result {
            padding: 20px;
            border-radius: 8px;
            margin-top: 30px;
            font-size: 1.2rem;
            text-align: center;
            font-weight: bold;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            display: none;
        }
        .loading-text {
            text-align: center;
            font-style: italic;
            color: #666;
            margin-top: 50px;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body>

    <h2>แบบทดสอบปรนัย: การขายประกันชีวิตและสุขภาพผ่านทางโทรศัพท์ (50 ข้อ)</h2>

    <div id="loading" class="loading-text">กำลังโหลดแบบทดสอบ...</div>

    <div style="margin-bottom: 20px;"><label for="name">ชื่อผู้ทำแบบทดสอบ:</label><input type="text" id="name" name="name" required style="width:100%;padding:10px;margin-top:5px;"></div>
<form id="quizForm" class="hidden"></form>

    <button id="submitBtn" class="hidden">ส่งคำตอบ</button>

    <div id="result"></div>
    
    <a href="index3.html">
        <button style="margin-top: 20px;">ไปหน้าถัดไป</button>
    </a>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

        // --- Supabase Setup ---
        const supabaseUrl = 'https://wzwyotzzxycqfwercakh.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind6d3lvdHp6eHljcWZ3ZXJjYWtoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcwNTg3MTMsImV4cCI6MjA3MjYzNDcxM30.lgiAf9oBUqsaWGb3u_80wuoKAODQHE_lIBxpGumhrno';
        const supabase = createClient(supabaseUrl, supabaseKey);

        let currentUser = null;

        // ข้อมูลคำถาม (ใช้ข้อมูลเดิมทั้งหมด)
        const questions = [
    { q: "1. หากผู้สมัครมีประวัติโรคตับแข็งจากการดื่มสุราเรื้อรัง บริษัทประกันจะพิจารณาอย่างไร?", a: "A", choices: ["ปฏิเสธการรับประกันทันที", "รับประกันโดยมีเงื่อนไข", "เพิ่มเบี้ยประกัน", "ให้ความคุ้มครองเฉพาะโรคตับ"] },
    { q: "2. การมีประวัติโรคพาร์กินสันส่งผลต่อการพิจารณาประกันในด้านใดมากที่สุด?", a: "B", choices: ["ความเสี่ยงต่อการเสียชีวิต", "ความเสี่ยงต่อการทุพพลภาพถาวร", "ความเสี่ยงต่อการติดเชื้อ", "ความเสี่ยงต่อการเกิดอุบัติเหตุ"] },
    { q: "3. โรคใดที่มีลักษณะเป็นโรคทางพันธุกรรมและมีผลต่อการสร้างเม็ดเลือดแดงผิดปกติ?", a: "A", choices: ["ธาลัสซีเมีย", "SLE", "โรคเบาหวาน", "โรคถุงลมโป่งพอง"] },
    { q: "4. หากผู้สมัครมีภาวะตาบอดทั้งสองข้างตั้งแต่กำเนิด บริษัทประกันจะพิจารณาอย่างไร?", a: "A", choices: ["ปฏิเสธการรับประกัน", "เพิ่มเบี้ยประกัน", "ให้ความคุ้มครองเฉพาะอุบัติเหตุ", "รับประกันโดยไม่มีเงื่อนไข"] },
    { q: "5. โรคใดที่มีผลต่อระบบประสาทส่วนกลางและอาจทำให้เกิดอาการชักซ้ำ?", a: "A", choices: ["โรคลมชัก", "โรควิตกกังวล", "โรคซึมเศร้า", "โรคสมาธิสั้น"] },
    { q: "6. การไม่แถลงโรคประจำตัวในการสมัครประกันจะส่งผลอย่างไรในทางกฎหมาย?", a: "B", choices: ["ถูกปรับเบี้ยประกันย้อนหลัง", "ถูกปฏิเสธการเคลมแม้มีกรมธรรม์", "ถูกยกเลิกกรมธรรม์ทันที", "ไม่มีผลต่อการเคลม"] },
    { q: "7. โรคใดที่มีผลต่อระบบภูมิคุ้มกันและอาจทำให้เกิดการอักเสบทั่วร่างกาย?", a: "A", choices: ["SLE", "โรคหอบหืด", "โรคข้อเสื่อม", "โรคเบาหวาน"] },
    { q: "8. หากผู้สมัครมีประวัติเส้นเลือดในสมองตีบ บริษัทประกันจะพิจารณาอย่างไร?", a: "A", choices: ["ปฏิเสธการรับประกัน", "เพิ่มเบี้ยประกัน", "รับประกันโดยมีเงื่อนไข", "ให้ความคุ้มครองเฉพาะอุบัติเหตุ"] },
    { q: "9. โรคใดที่มีความเสี่ยงต่อการแพร่เชื้อสูงและมักถูกปฏิเสธการประกัน?", a: "A", choices: ["HIV/AIDS", "โรคหัด", "โรคไข้หวัดใหญ่", "โรคตาแดง"] },
    { q: "10. การมีประวัติโรคเบาหวานที่ต้องฉีดอินซูลินส่งผลต่อการพิจารณาอย่างไร?", a: "A", choices: ["ปฏิเสธการรับประกัน", "เพิ่มเบี้ยประกัน", "รับประกันโดยไม่มีเงื่อนไข", "ให้ความคุ้มครองเฉพาะโรคเบาหวาน"] },
    { q: "11. โรคใดที่มีผลต่อการพัฒนาทางสมองและพฤติกรรมตั้งแต่เด็ก?", a: "A", choices: ["ดาวน์ซินโดรม", "โรคสมาธิสั้น", "โรควิตกกังวล", "โรคเครียด"] },
    { q: "12. หากผู้สมัครมีภาวะกล้ามเนื้ออ่อนแรงตั้งแต่กำเนิด จะส่งผลต่อการพิจารณาอย่างไร?", a: "A", choices: ["ปฏิเสธการรับประกัน", "เพิ่มเบี้ยประกัน", "รับประกันโดยมีเงื่อนไข", "ให้ความคุ้มครองเฉพาะอุบัติเหตุ"] },
    { q: "13. โรคใดที่มีผลต่อระบบหายใจและมักถูกพิจารณาอย่างเข้มงวด?", a: "A", choices: ["โรคถุงลมโป่งพอง", "โรคหอบหืด", "โรคหวัด", "โรคภูมิแพ้"] },
    { q: "14. หากผู้สมัครมีประวัติโรคซึมเศร้าเรื้อรัง บริษัทประกันจะพิจารณาอย่างไร?", a: "A", choices: ["ปฏิเสธการรับประกัน", "เพิ่มเบี้ยประกัน", "รับประกันโดยไม่มีเงื่อนไข", "ให้ความคุ้มครองเฉพาะจิตเวช"] },
    { q: "15. โรคใดที่มีผลต่อการทำงานของต่อมไทรอยด์และต้องควบคุมด้วยยา?", a: "A", choices: ["ไทรอยด์เป็นพิษ", "โรคเบาหวาน", "โรคตับอักเสบ", "โรคข้ออักเสบ"] },
    { q: "16. หากผู้สมัครมีประวัติโรคมะเร็งที่รักษาหายแล้ว บริษัทประกันจะพิจารณาอย่างไร?", a: "A", choices: ["รับประกันโดยมีเงื่อนไข", "ปฏิเสธการรับประกันทันที", "เพิ่มเบี้ยประกัน", "ให้ความคุ้มครองเฉพาะโรคมะเร็ง"] },
    { q: "17. โรคใดที่มีผลต่อระบบสืบพันธุ์และมักถูกปฏิเสธการประกัน?", a: "A", choices: ["ซิฟิลิส", "โรคหอบหืด", "โรคไข้เลือดออก", "โรคตาแดง"] },
    { q: "18. หากผู้สมัครมีภาวะอัมพาตจากอุบัติเหตุในอดีต บริษัทประกันจะพิจารณาอย่างไร?", a: "A", choices: ["ปฏิเสธการรับประกัน", "เพิ่มเบี้ยประกัน", "รับประกันโดยไม่มีเงื่อนไข", "ให้ความคุ้มครองเฉพาะอุบัติเหตุ"] },
    { q: "19. โรคใดที่มีผลต่อการสร้างภูมิคุ้มกันและอาจทำให้เกิดการติดเชื้อซ้ำ?", a: "A", choices: ["HIV/AIDS", "โรคหอบหืด", "โรคเบาหวาน", "โรคข้ออักเสบ"] },
    { q: "22. หากลูกค้าบอกว่าไม่มีเวลา ควรทำอย่างไร", a: "C", choices: ["พูดต่อทันที", "ตื๊อให้จบ", "ขอนัดเวลาใหม่", "วางสายไปเลย"] },
    { q: "23. การเสนอประกันแบบเร่งรีบมีผลอย่างไร", a: "D", choices: ["ลูกค้าซื้อทันที", "เข้าใจง่าย", "รู้สึกประทับใจ", "อาจทำให้ลูกค้าไม่เชื่อมั่น"] },
    { q: "24. ควรใช้ถ้อยคำอย่างไรเมื่ออธิบายกรมธรรม์", a: "B", choices: ["ศัพท์เทคนิคมาก ๆ", "ภาษาง่าย ๆ เข้าใจง่าย", "ใช้คำยาว ๆ", "แค่บอกชื่อแผน"] },
    { q: "25. ประโยชน์ของเบี้ยประกันที่ลูกค้าจ่ายคืออะไร", a: "A", choices: ["เป็นค่าคุ้มครองและสะสมทรัพย์", "เป็นค่าปรับ", "ไม่มีประโยชน์", "จ่ายให้ตัวแทน"] },
    { q: "26. การจดบันทึกระหว่างสนทนาช่วยได้อย่างไร", a: "C", choices: ["ไม่จำเป็น", "เสียเวลา", "ติดตามลูกค้าได้ดีขึ้น", "ทำให้ลืม"] },
    { q: "27. แนวทางตอบข้อโต้แย้งของลูกค้าคืออะไร", a: "D", choices: ["หลีกเลี่ยงการตอบ", "พูดให้จบไว", "พูดวกไปวนมา", "ฟังและตอบด้วยเหตุผลที่ตรงประเด็น"] },
    { q: "28. เมื่อลูกค้าถามเรื่องภาษี ควรตอบอย่างไร", a: "B", choices: ["ไม่ต้องรู้หรอก", "สามารถลดหย่อนภาษีได้ตามเงื่อนไขของกรมสรรพากร", "ไม่เกี่ยวกับกรมธรรม์", "ขึ้นกับดวง"] },
    { q: "29. ทำไมต้องเก็บข้อมูลลูกค้าอย่างเป็นระบบ", a: "C", choices: ["เพื่อลืมง่าย", "เพื่อโทรซ้ำโดยไม่รู้ตัว", "เพื่อติดตามผลและบริการภายหลัง", "เพื่อให้ข้อมูลซ้ำ ๆ"] },
    { q: "30. การตั้งเป้าหมายในการขายมีความสำคัญอย่างไร", a: "A", choices: ["ช่วยวางแผนการทำงาน", "ไม่มีผล", "ทำให้เครียด", "ไม่จำเป็น"] },
    { q: "31. การใช้คำถามเปิดในการพูดคุยช่วยอย่างไร", a: "B", choices: ["ทำให้ลูกค้ารู้สึกกดดัน", "ทำให้รู้ความต้องการลูกค้า", "เสียเวลา", "ทำให้ลูกค้าโกรธ"] },
    { q: "32. การใช้ภาษาที่เข้าใจง่ายสำคัญอย่างไร", a: "A", choices: ["ทำให้ลูกค้าเข้าใจง่ายขึ้น", "ทำให้ลูกค้าสับสน", "ไม่มีความหมาย", "ทำให้ดูไม่เป็นมืออาชีพ"] },
    { q: "33. เมื่อไหร่ควรเริ่มอธิบายผลประโยชน์", a: "C", choices: ["ทันทีที่โทร", "เมื่อจบการพูด", "เมื่อเข้าใจความต้องการลูกค้า", "เมื่อหมดเวลาพูด"] },
    { q: "34. การฟังอย่างตั้งใจช่วยอะไร", a: "D", choices: ["ทำให้เสียงดังขึ้น", "ลดเวลาพูด", "ไม่สำคัญ", "เข้าใจลูกค้ามากขึ้น"] },
    { q: "35. วิธีจัดการกับคำถามยากของลูกค้าคืออะไร", a: "B", choices: ["ตอบไปก่อนโดยไม่คิด", "ขอเวลาตรวจสอบข้อมูล", "เลี่ยงไม่ตอบ", "วางสาย"] },
    { q: "36. การสร้างความน่าเชื่อถือทำได้โดยวิธีใด", a: "A", choices: ["แนะนำตัวอย่างชัดเจน", "พูดเร็ว", "ไม่สนใจลูกค้า", "พูดให้จบเร็ว"] },
    { q: "37. คำถามประเภทไหนช่วยให้ลูกค้าพูดมากขึ้น", a: "C", choices: ["คำถามปลายปิด", "คำถามใช่/ไม่ใช่", "คำถามเปิด", "คำถามเดี่ยว"] },
    { q: "38. การสรุปเนื้อหาในการพูดสำคัญอย่างไร", a: "D", choices: ["ไม่สำคัญ", "ทำให้เสียเวลา", "ทำให้ลูกค้าเบื่อ", "ช่วยให้เข้าใจตรงกัน"] },
    { q: "39. วิธีปฏิเสธลูกค้าอย่างสุภาพควรทำอย่างไร", a: "B", choices: ["ตัดบททันที", "แสดงความเข้าใจและขอบคุณ", "พูดเสียงดัง", "วางสายทันที"] },
    { q: "40. เมื่อปิดการขายแล้ว ควรทำอะไรต่อ", a: "C", choices: ["เลิกงานทันที", "ไม่ต้องติดต่อลูกค้าอีก", "ติดตามผลและบริการหลังการขาย", "เปลี่ยนสายงาน"] },
    { q: "41. ข้อใดเป็นประโยชน์ของประกันสุขภาพ", a: "B", choices: ["เพิ่มหนี้สิน", "ช่วยลดภาระค่ารักษาพยาบาล", "ไม่มีประโยชน์", "เพิ่มความเสี่ยง"] },
    { q: "42. การอธิบายแผนประกันควรเน้นจุดใด", a: "C", choices: ["ราคาเพียงอย่างเดียว", "คำพูดทางเทคนิค", "ผลประโยชน์และความคุ้มครอง", "ความยาวของกรมธรรม์"] },
    { q: "43. คำพูดที่ควรหลีกเลี่ยงในการโทรขายคืออะไร", a: "A", choices: ["คำหยาบ", "คำสุภาพ", "คำถามเปิด", "คำชม"] },
    { q: "44. การรับฟังความคิดเห็นลูกค้าช่วยอย่างไร", a: "D", choices: ["ทำให้เสียเวลา", "ลดความน่าเชื่อถือ", "ทำให้ลูกค้ารู้สึกไม่ดี", "สร้างความสัมพันธ์ที่ดี"] },
    { q: "45. เมื่อลูกค้าสนใจแต่ยังไม่ตัดสินใจ ควรทำอย่างไร", a: "B", choices: ["ยกเลิกการติดต่อ", "นัดหมายติดตาม", "บังคับให้ซื้อ", "พูดเรื่องอื่น"] },
    { q: "46. การใช้คำพูดที่ชัดเจนช่วยอะไร", a: "A", choices: ["ทำให้ลูกค้าเข้าใจง่าย", "ทำให้สับสน", "เพิ่มเวลาโทร", "ลดความน่าเชื่อถือ"] },
    { q: "47. การพูดคุยด้วยความสุภาพช่วยอะไร", a: "C", choices: ["ทำให้ลูกค้าโกรธ", "ทำให้เสียเวลา", "สร้างความประทับใจ", "ทำให้พูดน้อยลง"] },
    { q: "48. ควรตอบคำถามลูกค้าอย่างไรเมื่อไม่ทราบคำตอบ", a: "B", choices: ["ตอบมั่วไปก่อน", "ขอเวลาตรวจสอบและติดต่อกลับ", "หลีกเลี่ยงไม่ตอบ", "วางสาย"] },
    { q: "49. การทำความเข้าใจความต้องการลูกค้าช่วยอะไร", a: "D", choices: ["ทำให้เสียเวลา", "ทำให้ลูกค้าเบื่อ", "ไม่มีผล", "เสนอแผนที่ตรงกับลูกค้า"] },
    { q: "50. ข้อใดคือสิ่งที่ควรจดบันทึกหลังโทรหาลูกค้า", a: "C", choices: ["จำนวนเพื่อนของลูกค้า", "ที่อยู่บ้าน", "ความต้องการและข้อสงสัยของลูกค้า", "วันเกิดของตัวแทน"] },
    { q: "49. ข้อใดต่อไปนี้เกี่ยวข้องกับโรคที่มักถูกปฏิเสธการทำประกัน?", a: "A", choices: ["โรคที่มีความเสี่ยงต่อชีวิตสูง", "โรคที่รักษาหายขาดแล้ว", "โรคทั่วไปที่ไม่รุนแรง", "โรคที่ไม่มีผลต่อการทำงาน"] },
    { q: "50. ข้อใดต่อไปนี้เกี่ยวข้องกับโรคที่มักถูกปฏิเสธการทำประกัน?", a: "A", choices: ["โรคที่มีความเสี่ยงต่อชีวิตสูง", "โรคที่รักษาหายขาดแล้ว", "โรคทั่วไปที่ไม่รุนแรง", "โรคที่ไม่มีผลต่อการทำงาน"] },
];
        // --- DOM Elements ---
        const quizForm = document.getElementById('quizForm');
        const submitBtn = document.getElementById('submitBtn');
        const loading = document.getElementById('loading');
        const resultDiv = document.getElementById('result');

        // ฟังก์ชันสร้างแบบทดสอบ (ไม่มีการเปลี่ยนแปลง)
        function renderQuiz() {
            loading.classList.add('hidden');
            quizForm.classList.remove('hidden');
            submitBtn.classList.remove('hidden');

            questions.forEach((q, index) => {
                const container = document.createElement('div');
                container.className = 'question-container';

                const questionTitle = document.createElement('h3');
                questionTitle.textContent = q.q;
                container.appendChild(questionTitle);

                const ul = document.createElement('ul');
                ul.className = 'choices';

                q.choices.forEach((choice, i) => {
                    const li = document.createElement('li');
                    const label = document.createElement('label');
                    const input = document.createElement('input');
                    input.type = 'radio';
                    input.name = `question-${index}`;
                    input.value = String.fromCharCode(65 + i);
                    label.appendChild(input);
                    label.appendChild(document.createTextNode(`${input.value}. ${choice}`));
                    li.appendChild(label);
                    ul.appendChild(li);
                });

                container.appendChild(ul);
                quizForm.appendChild(container);
            });
        }
        
        // **ปรับปรุงการเรียกใช้: ห่อการดึง User ไว้ในฟังก์ชัน**
        async function initialize() {
            // ดึงข้อมูล User ก่อน เพื่อให้ currentUser มีค่า
            try {
                const { data: { user }, error } = await supabase.auth.getUser();
                if (user) {
                    currentUser = user;
                }
            } catch (e) {
                console.warn("Could not retrieve current user. Running as anonymous.", e);
            }

            // เรียก renderQuiz() เพื่อสร้างคำถามหลังจากเตรียมข้อมูลเบื้องต้นเสร็จ
            renderQuiz();
        }

        // เริ่มต้นการทำงานทันทีเมื่อสคริปต์โหลด
        initialize();


        // --- Event Listener: Submit Button (ตรรกะ Supabase เดิมที่ถูกต้อง) ---
        submitBtn.addEventListener('click', async () => {
            // ปิดปุ่มทันทีเพื่อป้องกันการส่งซ้ำ
            submitBtn.disabled = true;

            let score = 0;
            const answers = [];

            // 1. คำนวณคะแนนและรวบรวมคำตอบ
            questions.forEach((q, index) => {
                const selected = document.querySelector(`input[name="question-${index}"]:checked`);
                const answer = selected ? selected.value : null; 
                answers.push(answer);
                if (answer === q.a) score++;
            });

            const totalQuestions = questions.length;
            const userId = currentUser?.id || "anonymous";
            const userEmail = currentUser?.email || "anonymous@example.com";
const userName = document.getElementById('name').value;

            // 2. บันทึกผลลัพธ์โดยใช้ Supabase Client
            const { error } = await supabase
                .from('quiz_results') // **ชื่อตาราง** (ต้องมีอยู่จริงใน Supabase)
                .insert([
                    {
                        user_id: userId,
                        user_email: userEmail,
                        score: score,
                        total_questions: totalQuestions,
                        name: userName,
answers: answers
                    }
                ]);

            // 3. จัดการผลลัพธ์และการแสดงผล
            if (error) {
                console.error('Error saving quiz result:', error.message);
                resultDiv.textContent = `เกิดข้อผิดพลาดในการบันทึกผล (รหัส: ${error.code}) กรุณาลองใหม่ หรือตรวจสอบ RLS ใน Supabase`;
                resultDiv.style.backgroundColor = '#ffd1d1';
                resultDiv.style.color = '#900';
                submitBtn.disabled = false; // อนุญาตให้ลองใหม่ได้
            } else {
                console.log("Quiz result saved successfully.");
                resultDiv.textContent = `บันทึกผลสำเร็จ! คุณได้คะแนน ${score} จาก ${totalQuestions} ข้อ`;
                resultDiv.style.backgroundColor = '#d1ffd1';
                resultDiv.style.color = '#005900';
            }

            resultDiv.style.display = 'block';
        });
    </script>
</body>
</html>
